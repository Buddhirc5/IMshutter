import tkinter as tk
from tkinter import filedialog, messagebox, ttk
from PIL import Image, ImageTk
import cv2
import numpy as np

# Initialize main window
root = tk.Tk()
root.title("Image Processing Application")
root.geometry("400x700")
root.configure(bg="#ffffff")  # White background

# Global variables
img_path = ""
img = None
processed_img = None
cropped_img = None

# Function to upload an image
def upload_image():
    global img_path, img, processed_img
    img_path = filedialog.askopenfilename()
    if img_path:
        img = cv2.imread(img_path)
        if img is not None:
            processed_img = img.copy()
            display_image(processed_img)
            show_edit_options()  # Show other editing options after uploading an image

# Function to display the image in the label
def display_image(img):
    if len(img.shape) == 2:  # Grayscale image
        im = Image.fromarray(img)
    else:  # Color image
        b, g, r = cv2.split(img)
        img = cv2.merge((r, g, b))
        im = Image.fromarray(img)
    imgtk = ImageTk.PhotoImage(image=im)
    image_label.config(image=imgtk)
    image_label.imgtk = imgtk  # Keep a reference to prevent garbage collection

# Function to rotate the image
def rotate_image():
    global processed_img
    if processed_img is not None:
        angle = 90  # Fixed angle of 90 degrees
        (h, w) = processed_img.shape[:2]
        center = (w // 2, h // 2)
        M = cv2.getRotationMatrix2D(center, angle, 1.0)
        rotated = cv2.warpAffine(processed_img, M, (w, h))
        display_image(rotated)
        processed_img = rotated  # Update the processed_img with the rotated image

# Function to crop the image
def crop_image():
    global cropped_img, processed_img
    if processed_img is not None:
        try:
            width = int(crop_width_entry.get())
            height = int(crop_height_entry.get())
        except ValueError:
            messagebox.showerror("Invalid Input", "Please enter valid width and height.")
            return
        
        h, w = processed_img.shape[:2]
        start_x = max(w // 2 - width // 2, 0)
        start_y = max(h // 2 - height // 2, 0)
        cropped_img = processed_img[start_y:start_y + height, start_x:start_x + width]
        display_image(cropped_img)
        processed_img = cropped_img  # Update the processed_img with the cropped image

# Function to invert the colors of the image
def invert_colors():
    global processed_img
    if processed_img is not None:
        inversion_type = inversion_dropdown.get()
        if inversion_type == "Invert Colors":
            inverted_img = cv2.bitwise_not(processed_img)
            display_image(inverted_img)
            processed_img = inverted_img  # Update the processed_img with the inverted image
        elif inversion_type == "Grayscale Inversion":
            # Convert to grayscale first, then invert
            gray_img = cv2.cvtColor(processed_img, cv2.COLOR_BGR2GRAY)
            inverted_img = cv2.bitwise_not(gray_img)
            display_image(inverted_img)
            processed_img = inverted_img  # Update the processed_img with the inverted grayscale image

# Function to show image properties
def show_properties():
    if processed_img is not None:
        img_pil = Image.open(img_path)
        properties = (
            f"Filename: {img_path}\n"
            f"Format: {img_pil.format}\n"
            f"Size: {img_pil.size}\n"
            f"Width: {processed_img.shape[1]}\n"
            f"Height: {processed_img.shape[0]}"
        )
        messagebox.showinfo("Image Properties", properties)

# Function to save the edited image
def save_image():
    if processed_img is not None:
        save_path = filedialog.asksaveasfilename(defaultextension=".jpg", initialfile="edited_image.jpg")
        if save_path:
            cv2.imwrite(save_path, cv2.cvtColor(processed_img, cv2.COLOR_BGR2RGB))
            messagebox.showinfo("Saved", "Image has been saved.")

# Function to show editing options after image upload
def show_edit_options():
    crop_button.grid(row=0, column=0, padx=10, pady=10)
    crop_width_label.grid(row=0, column=1, padx=5, pady=5)
    crop_width_entry.grid(row=0, column=2, padx=5, pady=5)
    crop_height_label.grid(row=0, column=3, padx=5, pady=5)
    crop_height_entry.grid(row=0, column=4, padx=5, pady=5)
    
    rotate_button.grid(row=1, column=0, padx=10, pady=10)
    invert_button.grid(row=1, column=1, padx=10, pady=10)
    inversion_dropdown.grid(row=1, column=2, padx=10, pady=10)
    properties_button.grid(row=2, column=0, padx=10, pady=10)
    save_button.grid(row=2, column=1, padx=10, pady=10)

# Style configuration for rounded buttons
style = ttk.Style()
style.theme_use('clam')  # Use 'clam' theme for better ttk styling support
style.configure('RoundedButton.TButton', font=('Helvetica', 12), padding=10, background='#e0f7ff', foreground='black')
style.map('RoundedButton.TButton', background=[('active', '#b3e5fc')], foreground=[('active', 'black')])

# Create a frame for scrollable content
main_frame = tk.Frame(root, bg="#ffffff")
main_frame.pack(fill='both', expand=True)

# Create a canvas for scrollable content
canvas = tk.Canvas(main_frame, bg="#ffffff", highlightthickness=0)
scrollbar_y = ttk.Scrollbar(main_frame, orient="vertical", command=canvas.yview)
scrollbar_x = ttk.Scrollbar(main_frame, orient="horizontal", command=canvas.xview)

scrollable_frame = tk.Frame(canvas, bg="#ffffff")  # Use tk.Frame for custom bg

scrollable_frame.bind(
    "<Configure>",
    lambda e: canvas.configure(
        scrollregion=canvas.bbox("all")
    )
)

canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
canvas.configure(yscrollcommand=scrollbar_y.set, xscrollcommand=scrollbar_x.set)

canvas.pack(side="left", fill="both", expand=True)
scrollbar_y.pack(side="right", fill="y")
scrollbar_x.pack(side="bottom", fill="x")

# Create image display label
image_label = tk.Label(scrollable_frame, bg="#ffffff")
image_label.pack(pady=20)

# Frame for buttons
button_frame = tk.Frame(scrollable_frame, bg="#ffffff")
button_frame.pack(pady=20)

# Icons for buttons
crop_icon = ImageTk.PhotoImage(Image.open("crop_icon.png").resize((20, 20)))
rotate_icon = ImageTk.PhotoImage(Image.open("rotate_icon.png").resize((20, 20)))
invert_icon = ImageTk.PhotoImage(Image.open("invert_icon.png").resize((20, 20)))
properties_icon = ImageTk.PhotoImage(Image.open("properties_icon.png").resize((20, 20)))
save_icon = ImageTk.PhotoImage(Image.open("save_icon.png").resize((20, 20)))
upload_icon = ImageTk.PhotoImage(Image.open("upload_icon.png").resize((20, 20)))

# Rounded Buttons with icons
crop_button = ttk.Button(button_frame, text="Crop", command=crop_image, style='RoundedButton.TButton', image=crop_icon, compound=tk.LEFT)
rotate_button = ttk.Button(button_frame, text="Rotate", command=rotate_image, style='RoundedButton.TButton', image=rotate_icon, compound=tk.LEFT)
invert_button = ttk.Button(button_frame, text="Invert Colors", command=invert_colors, style='RoundedButton.TButton', image=invert_icon, compound=tk.LEFT)
properties_button = ttk.Button(button_frame, text="Show Properties", command=show_properties, style='RoundedButton.TButton', image=properties_icon, compound=tk.LEFT)
save_button = ttk.Button(button_frame, text="Save", command=save_image, style='RoundedButton.TButton', image=save_icon, compound=tk.LEFT)

# Crop size entry fields
crop_width_label = ttk.Label(button_frame, text="Width:", background="#ffffff")
crop_width_entry = ttk.Entry(button_frame, width=10)
crop_height_label = ttk.Label(button_frame, text="Height:", background="#ffffff")
crop_height_entry = ttk.Entry(button_frame, width=10)

# Dropdown for inversion options
inversion_options = ["Invert Colors", "Grayscale Inversion"]
inversion_dropdown = ttk.Combobox(button_frame, values=inversion_options, state="readonly", width=15)
inversion_dropdown.current(0)

# Initially hide the edit options
crop_button.grid_forget()
rotate_button.grid_forget()
invert_button.grid_forget()
properties_button.grid_forget()
save_button.grid_forget()
inversion_dropdown.grid_forget()
crop_width_label.grid_forget()
crop_width_entry.grid_forget()
crop_height_label.grid_forget()
crop_height_entry.grid_forget()

# Main Frame for Upload Button
upload_button = ttk.Button(scrollable_frame, text="Upload Image", command=upload_image, style='RoundedButton.TButton', image=upload_icon, compound=tk.LEFT)
upload_button.pack(side='bottom', pady=30)

root.mainloop()
